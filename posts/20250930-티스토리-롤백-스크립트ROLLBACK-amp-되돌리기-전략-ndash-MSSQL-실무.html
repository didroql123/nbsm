<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>롤백 스크립트(ROLLBACK) &amp;amp; 되돌리기 전략 &amp;ndash; MSSQL 실무</title>
  <meta name="robots" content="index,follow">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; max-width: 800px; margin: auto; padding: 2em; }
    .title { font-size: 1.8em; font-weight: 800; margin-bottom: 0.5em; }
    .meta { color: #777; margin-bottom: 1em; }
    .summary { font-size: 1em; color: #333; margin-bottom: 2em; }
    .badge { display:inline-block; font-size: 0.85em; padding: 2px 8px; border-radius: 999px; background:#eef; margin-right:8px; }
    .summary img { max-width: 100%; height: auto; }
    a.button { background: #0077cc; color: white; padding: 0.6em 1em; text-decoration: none; border-radius: 6px; }
    a.button:hover { background: #005fa3; }
  </style>
</head>
<body>
  <div class="title">롤백 스크립트(ROLLBACK) &amp;amp; 되돌리기 전략 &amp;ndash; MSSQL 실무</div>
  <div class="meta"><span class="badge">티스토리</span>🗓 2025-09-30</div>
  <div class="summary"><p>업무 중 UPDATE&middot;DELETE 한 방에 잘못 날리면 식은땀이 나죠.<br />이 글은 <b>즉시 복구</b>부터 <b>사후 복구</b>까지, 상황별 되돌리기(rollback) 방법을 한 번에 정리합니다.</p>
<hr />
<h2>1) 트랜잭션 기본형 (실수 방지용 템플릿)</h2>
<div>
<div>
<div>&nbsp;</div>
</div>
<div>
<pre class="bash" id="code_1758585533039"><code>SET XACT_ABORT ON; -- 오류 시 자동 롤백(권장)

BEGIN TRAN;

-- ✅ 여기부터 작업
UPDATE dbo.Orders
SET    Status = 'Closed'
WHERE  OrderDate &lt; '2025-01-01';
-- ✅ 여기까지 작업

-- 점검
SELECT @@ROWCOUNT AS AffectedRows;

-- 확인 후 커밋/롤백
-- COMMIT;
-- ROLLBACK;</code></pre>
</div>
</div>
<ul>
<li>SET XACT_ABORT ON : 오류 한 번이면 자동 롤백(외래키/타임아웃 이슈에 특히 유용)</li>
</ul>
<hr />
<h2>2) TRY&hellip;CATCH + XACT_STATE() 안전 롤백</h2>
<div>
<div>
<div>&nbsp;</div>
</div>
<div>
<pre class="bash" id="code_1758585541656"><code>BEGIN TRY
    BEGIN TRAN;

    -- 위험 작업
    DELETE FROM dbo.Logs WHERE LogDate &lt; DATEADD(MONTH, -6, GETDATE());

    COMMIT;
END TRY
BEGIN CATCH
    IF XACT_STATE() &lt;&gt; 0 ROLLBACK;
    THROW; -- 오류 재발생(로그/모니터링)
END CATCH</code></pre>
<p>&nbsp;</p>
</div>
</div>
<hr />
<h2>3) SAVEPOINT로 &ldquo;부분만&rdquo; 되돌리기</h2>
<div>
<div>
<div>&nbsp;</div>
</div>
<div>
<pre class="bash" id="code_1758585555752"><code>BEGIN TRAN;

UPDATE dbo.A SET Qty = Qty - 10 WHERE Id = 1;
SAVE TRAN sv1;

UPDATE dbo.B SET Qty = Qty + 10 WHERE Id = 2;
-- 문제 발견!
ROLLBACK TRAN sv1; -- B만 되돌림

COMMIT; -- A는 반영</code></pre>
</div>
</div>
<hr />
<h2>4) 되돌릴 수 있는 UPDATE/DELETE (OUTPUT 백업 패턴)</h2>
<h3>4-1) UPDATE 롤백 가능하게 하기</h3>
<div>
<div>
<div>&nbsp;</div>
</div>
<div>
<pre class="bash" id="code_1758585566239"><code>-- 1) 백업
SELECT d.*
INTO   dbo._bak_Product_20250922
FROM   dbo.Product d WITH (HOLDLOCK, UPDLOCK) -- 동시변경 방지
WHERE  Category = 'A';

-- 2) 변경 + 변경 전 값 저장
DECLARE @chg TABLE (PK int, OldPrice money);
UPDATE p
SET    Price = Price * 1.1
OUTPUT inserted.Id, deleted.Price INTO @chg(PK, OldPrice)
FROM   dbo.Product p
WHERE  Category = 'A';

-- 3) 문제 시 되돌리기
-- UPDATE p SET Price = c.OldPrice
-- FROM dbo.Product p JOIN @chg c ON p.Id = c.PK;</code></pre>
</div>
</div>
<h3>4-2) DELETE 롤백 가능하게 하기</h3>
<div>
<div>
<div>&nbsp;</div>
</div>
<div>
<pre class="bash" id="code_1758585573055"><code>-- 1) 삭제 대상 백업
SELECT d.*
INTO   dbo._bak_OrderDetail_20250922
FROM   dbo.OrderDetail d WITH (HOLDLOCK, UPDLOCK)
WHERE  OrderDate &lt; '2024-01-01';

-- 2) 삭제
DELETE FROM dbo.OrderDetail
WHERE  OrderDate &lt; '2024-01-01';

-- 3) 되돌리기(필요 시)
-- INSERT INTO dbo.OrderDetail ( ...컬럼목록... )
-- SELECT ... 동일 컬럼 ...
-- FROM dbo._bak_OrderDetail_20250922;</code></pre>
</div>
</div>
<blockquote>
<p>포인트</p>
<ul>
<li><b>OUTPUT/백업 테이블</b>을 먼저 만들면 &ldquo;수동 undo&rdquo;가 쉬워집니다.</li>
<li>대용량은 TOP 10000 배치 + 야간 실행 추천.</li>
</ul>
</blockquote>
<hr />
<h2>5) INSERT 되돌리기(키 보관 후 삭제)</h2>
<div>
<div>&nbsp;</div>
<div>
<pre class="bash" id="code_1758585580919"><code>DECLARE @newKeys TABLE (PK int);

INSERT dbo.UserPoint(UserId, Point, Memo)
OUTPUT inserted.Id INTO @newKeys
SELECT u.Id, 100, 'event'
FROM dbo.Users u WHERE u.IsActive = 1;

-- 문제 시
-- DELETE p FROM dbo.UserPoint p JOIN @newKeys k ON p.Id = k.PK;</code></pre>
</div>
</div>
<hr />
<h2>6) 스키마(DDL) 변경의 롤백</h2>
<ul>
<li>DDL은 보통 <b>즉시 커밋</b>이라 실수 시 복구가 까다롭습니다.</li>
<li>원칙: <b>DDL도 트랜잭션</b>으로 감싸고, 변경 전 스크립트 준비.</li>
</ul>
<div>
<div>
<div>&nbsp;</div>
</div>
<div>
<pre class="bash" id="code_1758585588265"><code>BEGIN TRAN;

ALTER TABLE dbo.Customer ADD Phone2 VARCHAR(20) NULL;

-- 점검 후
-- COMMIT;
-- ROLLBACK; -- 일부 DDL은 롤백 가능/불가가 달라서 사전 테스트 필수</code></pre>
</div>
</div>
<blockquote>
<p>실무 팁</p>
<ul>
<li>마이그레이션 도구(예: SSDT/DACPAC, EF Migrations)의 <b>Down 스크립트</b>를 반드시 관리.</li>
<li>프로시저/뷰 수정은 <b>이전 버전 스크립트</b>를 저장소에 보관.</li>
</ul>
</blockquote>
<hr />
<h2>7) 사후 복구 시나리오 (이미 커밋됐다면)</h2>
<h3>7-1) 포인트 인 타임 복구(전체 DB 되돌리기)</h3>
<ul>
<li>전제: <b>전체 백업 + 로그 백업</b> 체계 운영.</li>
</ul>
<div>
<div>&nbsp;</div>
<div>
<pre class="bash" id="code_1758585595879"><code>-- 복구 예시(요지: 원하는 시각으로 STOPAT)
RESTORE DATABASE MyDB FROM DISK='full.bak' WITH NORECOVERY;
RESTORE LOG MyDB FROM DISK='log_2025_0922.trn' 
    WITH STOPAT = '2025-09-22T10:45:00', RECOVERY;</code></pre>
</div>
</div>
<blockquote>
<p>주의: <b>DB 전체 시점 이동</b>이라 운영에 영향 큼 &rarr; 보통 <b>별도 복구용 DB로 리스토어</b> 후, 차분 데이터만 추출/머지.</p>
</blockquote>
<h3>7-2) 시스템 버전형 테이블(Temporal Table) 활용</h3>
<ul>
<li>전제: 테이블에 시스템 시간 버전이 켜져 있어야 함.</li>
</ul>
<div>
<div>
<pre class="bash" id="code_1758585602951"><code>SELECT *
FROM dbo.Customer
FOR SYSTEM_TIME AS OF '2025-09-22 10:40:00'
WHERE Id = 1001;</code></pre>
</div>
<div>&nbsp;</div>
</div>
<p>&rarr; 과거 스냅샷에서 값 조회 후 <b>정상 테이블에 반영</b>.</p>
<h3>7-3) CDC(Change Data Capture)/감사 테이블</h3>
<ul>
<li>변경 이력에서 <b>전/후 이미지</b>를 조회해 반대로 적용.</li>
</ul>
<hr />
<h2>8) 실무 체크리스트</h2>
<ul>
<li>변경 전 <b>BEGIN TRAN</b>으로 가두고 확인 후 COMMIT</li>
<li>대량 작업은 <b>OUTPUT으로 백업</b>(되돌릴 증빙 확보)</li>
<li>야간 배치 + 작은 단위(TOP N)로 나눠 실행</li>
<li><b>인덱스/트리거/외래키</b> 영향 확인(순서/무결성)</li>
<li>정기 <b>백업/로그 백업</b> 유지 + 복구 리허설</li>
<li>스키마 변경은 <b>Down 스크립트</b>와 함께 배포</li>
</ul>
<hr />
<h2>✅ 한 장 요약 (추천 루틴)</h2>
<ol>
<li>변경 전: BEGIN TRAN &rarr; 대상 SELECT로 수량/범위 확인</li>
<li>백업: SELECT ... INTO _bak_YYYYMMDD 또는 OUTPUT 캡처</li>
<li>변경: UPDATE/DELETE/INSERT 실행</li>
<li>검증: 영향 건수&middot;무결성 체크</li>
<li>확정: COMMIT (문제 시 ROLLBACK + 백업 데이터로 되돌리기)</li>
<li>사후: 로그/문서화, 배치/모니터링 개선</li>
</ol></div>
  <a class="button" href="https://ksp668.tistory.com/26" target="_blank" rel="noopener">티스토리 블로그에서 전체 글 보기</a>
</body>
</html>
